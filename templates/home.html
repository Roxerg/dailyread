<!DOCTYPE html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">  
</head>


<body>
    <div style="text-align: right;"><span id="username">username loading</span> | <a href="/" onclick="logout()">logout</a></div>
    <div class="container">
        <div class="item">
            <div class="streak">
                <div class="fyah hidden">ðŸ”¥</div><span> STREAK </span><div class="fyah hidden">ðŸ”¥</div>
                <div class="streak-number" id="streak">???</div>       
                <br>
            </div>
            
            <div><button class="button-active" id="button" type="button" onclick="mark_today()">ðŸ“š</button></div>
            <br>
            <span id="until-text"></span><span id="demo"></span>
            <div class="selector">
                <div>
                    <b>Coming Soon</b>
                </div>
                <div>
                    Select Activity
                </div>
                <div class="comingsoon">
                    <span><</span>
                    <span class="unselected">ðŸŽ¸</span>
                    <span class="selected">ðŸ“š</span>
                    <span class="unselected">ðŸ¥—</span>
                    <span>></span>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
        
        const baseUrl = "{{ api_url }}"

        let token = localStorage.getItem('readertoken');
        let user  = localStorage.getItem('readeruser');
        document.getElementById("username").innerText = "roxerg";

        let clickedToday = false 
        let count = 0

        const remember = localStorage.getItem('remember');
        if (!remember) {
            sessionStorage.setItem('readertoken', token);
            sessionStorage.setItem('readeruser', user);

            localStorage.removeItem('readertoken');
            localStorage.removeItem('readeruser');
            localStorage.removeItem('remember');
        }

        function logout() {
            localStorage.removeItem('readertoken');
            localStorage.removeItem('readeruser');

            sessionStorage.removeItem('readertoken');
            sessionStorage.removeItem('readeruser');
        }

        if (!token) {
            window.location.replace("/");
        }
        
        function get_streak() {

            fetch(`${baseUrl}/today/verbose?user=${user}`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'GET',
            mode: 'cors',
            }).then((response) => {
            if (response.ok) {
                response.json().then((res) => {
                    count = res['streak']
                    document.getElementById("streak").innerText = count
                    const button = document.getElementById("button")
                    const disabled = (res['today'])

                    if (count > 7) {
                        document.querySelectorAll('.fyah').forEach((e) => {
                            e.classList.toggle('hidden')
                        })
                    }
                    

                    if (disabled) {
                        button.disabled = disabled
                        button.classList.toggle('button-active')
                        button.classList.toggle('button-marked')

                        clickedToday = true

                        document.getElementById("until-text").innerText = "Time until next check: "
                    }
                    
                })
            } else {
                document.getElementById("streak").innerText = -1
            }
            }).catch((e) => console.log("error", e));
        }

        function mark_today() {
            fetch(`${baseUrl}/mark-with-token`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'POST',
            mode: 'cors',
            }).then((response) => {
            if (response.ok) {
                response.text().then((txt) => {
                    document.getElementById("streak").innerText = count + 1
                    button.classList.toggle('button-active')
                    button.classList.toggle('button-marked')
                })
            } else {
                document.getElementById("streak").innerText = -1
            }
            }).catch((e) => console.log("error", e));

        }

        get_streak()



        // Set the date we're counting down to
const today = new Date();
let tomorrow = today.setDate(today.getDate() + 1)
tomorrow = new Date(`${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`)

let countDownDate = tomorrow.getTime()
// Update the count down every 1 second
let x = setInterval(function() {

  // Get today's date and time
  let now = new Date().getTime();

  // Find the distance between now and the count down date
  let distance = countDownDate - now;

  // Time calculations for days, hours, minutes and seconds
  let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  let seconds = Math.floor((distance % (1000 * 60)) / 1000);

  // Display the result in the element with id="demo"
  if (clickedToday) {
    document.getElementById("demo").innerHTML = hours + ":" + minutes + ":" + seconds;
  }
  

  // If the count down is finished, write some text
  if (distance < 0) {
    clearInterval(x);
    document.getElementById("demo").innerHTML = "Refresh";
    window.location.replace("/home");
  }
}, 1000);
        
</script>

<style>
    body {
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        background: #1b1b1b;
        color: #ffffff;
        overflow-y: hidden;
    }
    .container {
      display: grid;
      grid-template-columns: [lefty] 30% [midx] auto [righty] 30%;
      grid-template-rows: [topy] 10vh [midy] 80vh [bottomy] 10vh;
    }
    .fyah {
        display: inline-block;
        animation: flames 3s;
        animation-iteration-count: infinite;
        animation-timing-function: ease-in-out;
    }
    .hidden {
        visibility: hidden;
    }

    @keyframes flames {
        0% { opacity: 0.75; transform: rotate(-25deg);scale: 1;}
        25% { opacity: 1; transform: rotate(0deg);scale: 1.2;}
        50% { opacity: 0.75; transform: rotate(25deg); scale: 1;}
        75% { opacity: 1; transform: rotate(0deg);scale: 1.2;}
        100% { opacity: 0.75; transform: rotate(-25deg); scale: 1;}
    }

    /* @-moz-keyframes flames {
        0% { opacity: 0; transform: rotateZ(-90deg);}
        50% { opacity: 1; transform: rotateZ(90deg);}
        100% { opacity: 0; transform: rotateZ(-90deg);}
    }

    @-webkit-keyframes flames {
        0% { opacity: 0; transform: rotateZ(-90deg);}
        50% { opacity: 1; transform: rotateZ(90deg);}
        100% { opacity: 0; transform: rotateZ(-90deg);}
    } */

    .item {
        grid-column: midx;
        grid-row: midy;
        text-align: center;
    }
    .boxerg {
        padding-top: 15px;
        padding-bottom: 15px;
    }
    .padded {
        margin-bottom: 10px;
    }

    button {
        border-radius: 20vh;
        border-width: 20px;
        width: 30vh;
        height: 30vh;
        font-size: 10vh;
        border-style:solid;
        transition: all 0.5s;
    }

    .button-active {
        background-color:#2196f3;
        border-color: #6db4ee;
    }
    .button-active:hover {
        background-color:#107ad1;
        border-color: #8cc5f3;
        border-width: 30px;
        font-size: 12vh;
    }

    .button-marked {
        background-color:#005005;
        border-color: #2e7d32;
        border-width: 10px;
        font-size: 70px;
    }

    .selector {
        opacity: 50%;
        align-items: center;
        color: gray;
    }
    .comingsoon {
        font-size: 50px;
    }
    .unselected {
        font-size: 40px;
        opacity: 30%;
    }
    .selected {
        font-size: 60px;
    }
    .streak {
        font-size: 20px;
    }
    .streak-number {
        font-size: 30px;
    }
</style>
</html>
