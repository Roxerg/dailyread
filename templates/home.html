<!DOCTYPE html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">  
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>


<body>
    <div class="container">
        <div style="width: 98vw;">
            <div style="float: right;"><span id="username">username loading</span> | <a href="/" onclick="logout()">logout</a></div>
            <div style="float: left;">
                <span>
                <a onclick="showAbout()"><b>? </b></a>
                | 
                <a href="">leaderboard</a>
                | 
                <a href="">API</a>
                </span>
            </div>
        </div>
        <div class="item">
            <div class="streak">
                <div class="fyah hidden">ðŸ”¥</div><span> STREAK </span><div class="fyah hidden">ðŸ”¥</div>
                <div class="streak-number" id="streak">???</div>       
                <br>
            </div>
            <div><button class="main-button main-button-active" id="button" type="button" onclick="mark_today()">ðŸ“š</button></div>
            <br>
            <span id="until-text"></span><span id="demo"></span>
            <div class="selector">
                <div>
                    <b>Coming Soon</b>
                </div>
                <div>
                    Select Activity
                </div>
                <div class="comingsoon">
                    <span><</span>
                    <span class="unselected">ðŸŽ¸</span>
                    <span class="selected">ðŸ“š</span>
                    <span class="unselected">ðŸ¥—</span>
                    <span>></span>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
        
        const baseUrl = "{{ api_url }}"

        let token = localStorage.getItem('readertoken');
        let user  = localStorage.getItem('readeruser');
        document.getElementById("username").innerText = user;

        let clickedToday = false 
        let count = 0

        const remember = localStorage.getItem('remember');
        if (!remember) {
            sessionStorage.setItem('readertoken', token);
            sessionStorage.setItem('readeruser', user);

            localStorage.removeItem('readertoken');
            localStorage.removeItem('readeruser');
            localStorage.removeItem('remember');
        }

        function logout() {
            localStorage.removeItem('readertoken');
            localStorage.removeItem('readeruser');

            sessionStorage.removeItem('readertoken');
            sessionStorage.removeItem('readeruser');
        }

        if (!token) {
            window.location.replace("/");
        }

        function showAbout() {
            alert(
                "This application is used for tracking whether you have done { an activity } each day. Currently only one activity is supported. You can click the button once per day, the app will keep track of how many consecutive days you clicked the button. That's it. Made by: https://whois.rogu.rocks"
            )
        }
        
        function get_streak() {

            fetch(`${baseUrl}/today/verbose?user=${user}`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'GET',
            mode: 'cors',
            }).then((response) => {
            if (response.ok) {
                response.json().then((res) => {
                    count = res['streak']
                    document.getElementById("streak").innerText = count
                    const button = document.getElementById("button")
                    const disabled = (res['today'])

                    if (count > 7) {
                        document.querySelectorAll('.fyah').forEach((e) => {
                            e.classList.toggle('hidden')
                        })
                    }
                    

                    if (disabled) {
                        button.disabled = disabled
                        button.classList.toggle('main-button-active')
                        button.classList.toggle('main-button-marked')

                        clickedToday = true

                        document.getElementById("until-text").innerText = "Time until next check: "
                    }
                    
                })
            } else {
                document.getElementById("streak").innerText = -1
            }
            }).catch((e) => console.log("error", e));
        }

        function mark_today() {
            fetch(`${baseUrl}/mark-with-token`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'POST',
            mode: 'cors',
            }).then((response) => {
            if (response.ok) {
                response.text().then((txt) => {
                    document.getElementById("streak").innerText = count + 1
                    button.classList.toggle('main-button-active')
                    button.classList.toggle('main-button-marked')
                })
            } else {
                document.getElementById("streak").innerText = -1
            }
            }).catch((e) => console.log("error", e));

        }

        get_streak()



        // Set the date we're counting down to
const today = new Date();
let tomorrow = today.setDate(today.getDate() + 1)
tomorrow = new Date(`${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`)

let countDownDate = tomorrow.getTime()
// Update the count down every 1 second
let x = setInterval(function() {

  // Get today's date and time
  let now = new Date().getTime();

  // Find the distance between now and the count down date
  let distance = countDownDate - now;

  // Time calculations for days, hours, minutes and seconds
  let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  let seconds = Math.floor((distance % (1000 * 60)) / 1000);

  // Display the result in the element with id="demo"
  if (clickedToday) {
    document.getElementById("demo").innerHTML = hours + ":" + minutes + ":" + seconds;
  }
  

  // If the count down is finished, write some text
  if (distance < 0) {
    clearInterval(x);
    document.getElementById("demo").innerHTML = "Refresh";
    window.location.replace("/home");
  }
}, 1000);
        
</script>

<style>

    .boxerg {
        padding-top: 15px;
        padding-bottom: 15px;
    }
    .padded {
        margin-bottom: 10px;
    }


    .selector {
        opacity: 50%;
        align-items: center;
        color: gray;
    }
    .comingsoon {
        font-size: 5vw;
    }
    .unselected {
        font-size: 60%;
        opacity: 30%;
    }
    .selected {
        font-size: 90%;
    }
    .streak {
        font-size: 20px;
    }
    .streak-number {
        font-size: 30px;
    }
</style>
</html>
