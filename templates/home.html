<!DOCTYPE html>

<head>
    <title>read?.(today)</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">  
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>


<body>
    <div id="dongle" class="silly out-of-reach"></div>
    <div id="sidebar-leaderboard" class="sidebar out-of-reach">
        couldn't load :(<br>
    </div>
    <div id="sidebar-about" class="sidebar out-of-reach">
        This application is used for tracking whether you have done { an activity } each day. <br>
        Currently only one activity is supported. <br>
        You can click the button once per day, <br>
        the app will keep track of how many consecutive days you clicked the button. <br>
        That's it. 
        <br>
        made by <a href="https://whois.rogu.rocks">rokas g</a><br>
    </div>
    <div id="sidebar-api" class="sidebar out-of-reach">
        This section will be expanded. <br>
        You can use the tracker directly via API. <br>
        To get current streak, you do not need any
        authentication: <br>
        <div class="codeblock">
            curl \ <br>
              --request GET \ <br> 
              --url <span class="codetext">'{{ api_url }}/today?user=<span class="username codetextalt"></span>'</span> <br>
        </div>
        To mark current day as complete, you need to pass login <br>
        details to the request:
        <div class="codeblock">
            curl \ <br> 
            --request GET \ <br>
            --url <span class="codetext">'{{ api_url }}/mark'</span> \ <br>
            --header <span class="codetext">'Content-Type: application/json'</span> \ <br>
            --data <span class="codetext">'{ <br>
	            "user": "<span class="username codetextalt"></span>", <br>
	            "pass": "<span class="codetextalt">%your password%</span>" <br>
            }' <br> </span>
        </div>
    </div>

    <div class="container">
        <div style="width: 98vw;">
            <div style="float: right;"><span class="username">username loading</span> | <a href="/" onclick="logout()">logout</a></div>
            <div style="margin-left: 3px; float: left;">
                <span>
                <a onclick="showAbout()"><b>? </b></a>
                | 
                <a onclick="leaderboard()">leaderboard</a>
                | 
                <a onclick="showApi()">API</a>
                </span>
            </div>
            
        </div>
        <div id="main-stuff" class="item">
            <div class="streak">
                <div class="fyah hidden">ðŸ”¥</div><span> STREAK </span><div class="fyah hidden">ðŸ”¥</div>
                <div class="streak-number" id="streak">???</div>       
                <br>
            </div>
            <div><button class="main-button main-button-active" id="button" type="button" onclick="mark_today()">ðŸ“š</button></div>
            <br>
            <span id="until-text"></span><span id="demo"></span>
            <div class="selector">
                <div>
                    <b>Coming Soon</b>
                </div>
                <div>
                    Select Activity
                </div>
                <div class="comingsoon">
                    <span><</span>
                    <span class="unselected">ðŸŽ¸</span>
                    <span class="selected">ðŸ“š</span>
                    <span class="unselected">ðŸ¥—</span>
                    <span>></span>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
        
        const baseUrl = "{{ api_url }}"

        let token = localStorage.getItem('readertoken');
        let user  = localStorage.getItem('readeruser');
        document.querySelectorAll('.username').forEach((e) => {
            e.innerText = user;
        })

        let clickedToday = false 
        let count = 0

        const remember = localStorage.getItem('remember');
        if (!remember) {
            sessionStorage.setItem('readertoken', token);
            sessionStorage.setItem('readeruser', user);

            localStorage.removeItem('readertoken');
            localStorage.removeItem('readeruser');
            localStorage.removeItem('remember');
        }

        function logout() {
            fetch(`${baseUrl}/logout?user=${user}`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'GET',
            mode: 'cors',
            }).then((response) => {console.log("logged out")})
            localStorage.removeItem('readertoken');
            localStorage.removeItem('readeruser');

            sessionStorage.removeItem('readertoken');
            sessionStorage.removeItem('readeruser');
        }

        if (!token) {
            window.location.replace("/login");
        }

        let leaderboardVisible = false
        let aboutVisible = false
        let apiVisible = false


        function showAbout() {
            if (leaderboardVisible) leaderboard()
            if (apiVisible) showApi()
            aboutVisible = !aboutVisible
            document.getElementById('sidebar-about').classList.toggle("out-of-reach")
            document.getElementById('dongle').classList.toggle("out-of-reach")
            document.getElementById('dongle').classList.toggle("dongle-about")
        }
        
        function leaderboard() {
            if (aboutVisible) showAbout()
            if (apiVisible) showApi()
            leaderboardVisible = !leaderboardVisible
            document.getElementById('sidebar-leaderboard').classList.toggle("out-of-reach")
            document.getElementById('dongle').classList.toggle("out-of-reach")
            document.getElementById('dongle').classList.toggle("dongle-leaderboard")
        }

        function showApi() {
            if (aboutVisible) showAbout()
            if (leaderboardVisible) leaderboard()
            apiVisible = !apiVisible
            document.getElementById('sidebar-api').classList.toggle("out-of-reach")
            document.getElementById('dongle').classList.toggle("out-of-reach")
            document.getElementById('dongle').classList.toggle("dongle-api")
        }

        function hideAllSidebars() {
            if (aboutVisible) showAbout()
            if (leaderboardVisible) leaderboard()
            if (apiVisible) showApi()
        }

        function get_leaderboard() {
            fetch(`${baseUrl}/leaderboard`,  {
                headers: {
                    'Authorization' : 'Bearer ' + token
                },
                method: 'GET',
                mode: 'cors',}).then((r) => {
                    if (r.ok) {
                        r.json().then((j) => {

                            const toplist = j["leaderboard"].map((e) => {


                                let topUser
                                if (e.user === user) {
                                    topUser = `<b class="leaderboard-you">${e.user}</b>`
                                } else {
                                    topUser = e.user
                                }

                                return `${e.rank}. ${topUser} (x${e.streak}) <br>`
                            }).join("")


                            document.getElementById("sidebar-leaderboard").innerHTML = toplist
                        })
                    }
                })
        }
        
        function get_streak() {

            fetch(`${baseUrl}/today/verbose?user=${user}`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'GET',
            mode: 'cors',
            }).then((response) => {
            if (response.ok) {
                response.json().then((res) => {
                    count = res['streak']
                    document.getElementById("streak").innerText = count
                    const button = document.getElementById("button")
                    const disabled = (res['today'])

                    if (count > 7) {
                        document.querySelectorAll('.fyah').forEach((e) => {
                            e.classList.toggle('hidden')
                        })
                    }
                    

                    if (disabled) {
                        button.disabled = disabled
                        button.classList.toggle('main-button-active')
                        button.classList.toggle('main-button-marked')

                        clickedToday = true

                        document.getElementById("until-text").innerText = "Time until next check: "
                    }
                    
                })
            } else {
                document.getElementById("streak").innerText = -1
            }
            }).catch((e) => console.log("error", e));
        }

        function mark_today() {
            fetch(`${baseUrl}/mark-with-token`,  {
            headers: {
                'Authorization' : 'Bearer ' + token
            },
            method: 'POST',
            mode: 'cors',
            }).then((response) => {
            if (response.ok) {
                response.text().then((txt) => {
                    document.getElementById("streak").innerText = count + 1
                    button.classList.toggle('main-button-active')
                    button.classList.toggle('main-button-marked')
                })
            } else {
                document.getElementById("streak").innerText = -1
            }
            }).catch((e) => console.log("error", e));

        }

        get_streak()
        get_leaderboard()

        document.getElementById("main-stuff").addEventListener("click", () => {
            hideAllSidebars()
        })



        // Set the date we're counting down to
const today = new Date();
let tomorrow = today.setDate(today.getDate() + 1)
tomorrow = new Date(`${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`)

let countDownDate = tomorrow.getTime()
// Update the count down every 1 second
let x = setInterval(function() {

  // Get today's date and time
  let now = new Date().getTime();

  // Find the distance between now and the count down date
  let distance = countDownDate - now;

  // Time calculations for days, hours, minutes and seconds
  let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  let seconds = Math.floor((distance % (1000 * 60)) / 1000);

  // Display the result in the element with id="demo"
  if (clickedToday) {
    document.getElementById("demo").innerHTML = hours + ":" + minutes  + ":" + seconds;
    document.getElementById("demo").innerHTML = `${hours}:${minutes >= 10 ? minutes : '0' + minutes}:${seconds >= 10 ? seconds : '0' + seconds}`;
  }
  

  // If the count down is finished, write some text
  if (distance < 0) {
    clearInterval(x);
    document.getElementById("demo").innerHTML = "Refresh";
    window.location.replace("/home");
  }
}, 1000);
        
</script>
</html>
